<% edition_mode = (defined? edition_mode) ? edition_mode : false %>

<% @comment ||= Comment.new %>

<% if @comment.errors.any? %>
  <%= error_messages_for :comment %>
<% end %>

  <%= remote_form_for(@comment, :url => {:profile => profile.identifier, :controller => 'comment', :action => (edition_mode ? 'update' : 'create'), :id => (edition_mode ?  @comment.id : @page.id)}, :html => { :class => 'comment_form' } ) do |f| %>

    <%= link_to(profile_image(current_person, :minor), current_person.url) if logged_in? %>
    <%= expandable_text_area :comment, :body, "comment-field", rows: 1, title: _('Leave your comment'), placeholder: _('Leave your comment') %>

    <% unless logged_in? %>
      <p><%= _('If you are a registered user, you can login and be automatically recognized.') %></p>
    <% end %>


    <% if !edition_mode %>
      <%= captcha_tags(:create_comment, user, environment, profile) %>
    <% end %>

    <%= hidden_field_tag(:confirm, 'false') %>
    <%= hidden_field_tag(:view, params[:view])%>
    <%= hidden_field_tag(:reply_of_id) %>

    <%= safe_join(@plugins.dispatch(:comment_form_extra_contents, local_assigns.merge(:comment => @comment)).collect { |content| instance_exec(&content) }, "") %>
  <% end %>

<%= javascript_include_tag 'comment_form'%>
